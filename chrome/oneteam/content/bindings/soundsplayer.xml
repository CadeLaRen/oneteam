<?xml version="1.0"?>

<bindings xmlns="http://www.mozilla.org/xbl"
    xmlns:xbl="http://www.mozilla.org/xbl"
    xmlns:html="http://www.w3.org/1999/xhtml"
    xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">

  <binding id="player">

    <resources>
      <stylesheet src="chrome://global/skin"/>
    </resources>

    <content>
      <xul:vbox anonid="box">
      </xul:vbox>
    </content>

    <implementation>
      <constructor><![CDATA[
// #ifdef XULAPP
        this._player = Components.classes["@mozilla.org/sound;1"].
          createInstance(Components.interfaces.nsISound);
        this._ios = Components.classes["@mozilla.org/network/io-service;1"].
          getService(Components.interfaces.nsIIOService);
/* #else
        if (window.top.playSound) {
          this._flash = { playSound: window.top.playSound,  stopSound: window.top.stopSound };
          return;
        }
        var plugin = window.navigator.mimeTypes.namedItem("application/x-shockwave-flash");
        if (!plugin || !plugin.enabledPlugin)
            return;

        var flash = document.createElementNS("http://www.w3.org/1999/xhtml", "embed");
        flash.setAttribute("width", "1");
        flash.setAttribute("height", "1");
        flash.setAttribute("type", "application/x-shockwave-flash");
        flash.setAttribute("bgcolor", "#FFFFFF");
        flash.setAttribute("src", document.location.toString().
          replace(/(?:jar:)?(.*?)(?:(?:\/[^\/!]+!\/)|\/content\/).*$/, "$1/sounds/player.swf"));
        document.getAnonymousElementByAttribute(this, "anonid", "box").appendChild(flash);

        this._flash = flash;
// #endif */
      ]]></constructor>

      <method name="playSound">
        <parameter name="type"/>
        <parameter name="loops"/>
        <body><![CDATA[
          try {
            if (!prefManager.getPref("chat.sounds"))
              return;
            if (this._player) {
              if (!this._threadCreated && !this._thread) {
                this._threadCreated = true;
                try {
                  if (navigator.platform.search(/linux/i) >= 0)
                    this._thread = Components.classes["@mozilla.org/thread-manager;1"].
                      getService(Components.interfaces.nsIThreadManager).newThread(0);
                } catch (ex) {}
              }
              var url = this._ios.newURI("chrome://oneteam/content/data/sounds/"+
                                         type+".wav", null, null);
              if (this._thread) {
                if (!this._playing || !this._playing.value) {
                  this._playing.value = true;

                  this._thread.dispatch({
                    run: function() {
                      this.player.play(this.url)
                      this.playing.value = false;
                    },

                    player: this._player,
                    playing: this._playing,
                    url: url
                  }, this._thread.DISPATCH_NORMAL);
                }
              } else
                this._player.play(url);
            } else if (this._flash)
              this._flash.playSound(document.location.toString().
                replace(/(?:jar:)?(.*?)(?:(?:\/[^\/!]+!\/)|\/content\/).*/, "$1/sounds/"+type+".mp3"),
                loops);
          } catch(ex){ alert(ex)}
        ]]></body>
      </method>
      <method name="stopSound">
        <parameter name="type"/>
        <body><![CDATA[
          try {
            if (!prefManager.getPref("chat.sounds"))
              return;
            if (this._flash)
              this._flash.stopSound(document.location.toString().
                replace(/(?:jar:)?(.*?)(?:(?:\/[^\/!]+!\/)|\/content\/).*/, "$1/sounds/"+type+".mp3"));
          } catch(ex){}
        ]]></body>
      </method>
    </implementation>
  </binding>
</bindings>
