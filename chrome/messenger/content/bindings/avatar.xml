<?xml version="1.0"?>

<bindings xmlns="http://www.mozilla.org/xbl"
    xmlns:xbl="http://www.mozilla.org/xbl"
    xmlns:html="http://www.w3.org/1999/xhtml"
    xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">

  <binding id="avatar">

    <resources>
      <stylesheet src="chrome://global/skin"/>
      <stylesheet src="chrome://messenger/skin/avatar.css"/>
    </resources>

    <content>
      <xul:hbox flex="1" align="center">
        <xul:vbox style="background: white; padding: 1px; border: 1px solid #999"
            hidden="true">
          <html:div>
            <html:img id="image" width="1" height="1" style="display: block"
              onload="try{this.parentNode.parentNode.parentNode.parentNode.onImageLoad()}catch(ex){}"/>
          </html:div>
        </xul:vbox>
      </xul:hbox>
    </content>

    <implementation>

      <property name="model">
        <getter><![CDATA[
          return this._model;
        ]]></getter>

        <setter><![CDATA[
          if (this._model == val)
            return val;

          if (this._token) {
            this._model.unregisterView(this._token);
            this._token = null;
          }

          if (val) {
            this._model = val;
            this._token = this._model.registerView(this.onAvatarChange, this, "avatar");
          }
          this.onAvatarChange();

          return val;
        ]]></setter>
      </property>
      <constructor>
        <![CDATA[
          this._image = document.getAnonymousElementByAttribute(this, "id", "image");
          this._container = this._image.parentNode.parentNode.parentNode;
          if (this.model) {
            this._model = this.model;
            this._token = this._model.registerView(this.onAvatarChange, this, "avatar");
          }
          this.onAvatarChange();
        ]]>
      </constructor>

      <destructor>
        <![CDATA[
          this.model = null;
        ]]>
      </destructor>

      <method name="onAvatarChange">
        <body><![CDATA[
        if (this._model && this._model.avatar) {
          this._container.firstChild.hidden = false;
          this._src = this._model.avatar;
          this._image.setAttribute("src", this._src);
        } else if (this.getAttribute("showBlankAvatar") == "true") {
          this._container.firstChild.hidden = false;
            this._src = "chrome://messenger/skin/default-avatar.png";
            this._image.setAttribute("src", this._src);
        } else {
          this._container.firstChild.hidden = true;
          this._src = null;
        }
        ]]></body>
      </method>

      <method name="onImageLoad">
        <body><![CDATA[
          if (this._src != this._image.src) {
            relD = this._src.split(/\.\.\//);
            idx = relD.lastIndexOf("")+1;
            var absSrc = document.location.href.split(/\//).slice(0, -idx-1).
              concat(relD[idx]).join("/");
            if (absSrc != this._image.src) {
              this._image.src = this._src;
              return;
            }
          }

          this._image.width = this._image.height = 1;
          var height = this._container.boxObject.height - 4;

          if (height > this._image.naturalHeight)
            height = this._image.naturalHeight;

          this._image.width = height*this._image.naturalWidth/this._image.naturalHeight;
          this._image.height = height;
        ]]></body>
      </method>
    </implementation>

  </binding>

</bindings>
