<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html>
  <head>
    <title>OneTeam</title>
    <meta http-equiv="content-type" content="text/html; charset=iso-8859-1">
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      iframe, #launch, #useff {
        position: absolute;
        margin: 0;
        padding: 0;
        border: none;
        top: 0;
        bottom: 0;
        width: 100%;
        display: none;
      }
      #launch, #useff {
        text-align: center;
      }
      #useffbox {
        position: absolute;
        width: 500px;
        height: 150px;
        left: 50%;
        top: 50%;
        margin-left: -250px;
        margin-top: -75px;
      }
      #launchbox {
        position: absolute;
        width: 260px;
        height: 100px;
        left: 50%;
        top: 50%;
        margin-left: -120px;
        margin-top: -50px;
      }
      #launchButton {
        width: 260px;
        height: 100px;
        /*color: transparent;*/
        font-size: 0;
        border: 0;
        background: url(launch-button.png) transparent;
        cursor: pointer;
      }
    </style>
    <script type="text/javascript">
      try {
        window.storage = window.globalStorage[document.location.host.replace(/:\d+$/, "")];
      } catch (ex) {};

      var schema = document.location.toString().replace(/(?:jar:)?(.*?):.*/, "$1");

      if (window.storage) {
        var keysToDel = [], keysToSet = [], cacheNewKey;

        for (var i = 0; i < storage.length; i++) {
          try {
            cacheNewKey = storage.key(i).replace(/^cache:/, ":cache:value:").
              replace(/^cacheExpiration:/, ":cache:expiration:").
              replace(/^pref-str:/, ":prefs:str:").
              replace(/^pref-bool:/, ":prefs:bool:").
              replace(/^pref-num:/, ":prefs:int:");
            if (cacheNewKey != storage.key(i)) {
              keysToSet.push([schema+cacheNewKey, storage[storage.key(i)]]);
              if (schema != "https")
                keysToDel.push(storage.key(i));
            }
          } catch (ex) { }
        }

        for (i = 0; i < keysToSet.length; i++)
          try {
            storage[keysToSet[i][0]] = keysToSet[i][1];
          } catch (ex) { }

        for (i = 0; i < keysToDel.length; i++)
          try {
            delete storage[keysToDel[i]];
          } catch (ex) { }
      }

      function browserCheck()
      {
        if (!window.storage)
          return false;
        var el = document.
          createElementNS("http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul",
                          "hbox");
        el.setAttribute("flex", 1);

        return !!el.flex;
      }

      function onLoad() {
        if (document.location.search == "?t=1")
          launch(true);
        else if (browserCheck()) {
          document.getElementById("mode").checked = storage[schema+":openInNewWindow"] != "false";
          document.getElementById("launch").style.display = "block"
        } else {
          document.getElementById("useff").style.display = "block"
        }
      }

      function launch(thisWindow) {
        var newWin = document.getElementById("mode").checked;
        storage[schema+":openInNewWindow"] = !! newWin;
        if (!thisWindow && newWin) {
          window.open(document.location.href+"?t=1", "_blank",
              "chrome,resizable=yes,dialog=no,all");
        } else {
          var frame = document.getElementById("frame");
          frame.style.display = "block";
          frame.src = "jar:"+document.location.href.replace(/\/[^\/]*$/,
              "/oneteam.jar!/content/main.xul");
        }
      }
    </script>
    <script type="text/javascript;version=1.7">
      function StorageWrapper(prefix)
      {
        if (!window.storage)
          throw "Can't access globalStorage";
        this.prefix = schema+":"+prefix+":";
        this.storage = window.storage;
      }

      StorageWrapper.prototype =
      {
        __iterator__: function(keysOnly) {
          for (var i = 0; i < storage.length; i++)
            try {
              if (storage.key(i).indexOf(this.prefix) == 0) {
                var key = storage.key(i).substr(this.prefix.length);
                if (keysOnly)
                  yield (key);
                else {
                  var val = storage[storage.key(i)];
                  yield ([key, val == null ? null : ""+val]);
                }
              }
            } catch (ex) { this.report("developer", "error", ex) }
          throw StopIteration;
        },

        "get": function(key)
        {
          try {
            var val = storage[this.prefix+key];
            return val == null ? null : ""+val;
          } catch(ex) { this.report("developer", "error", ex) }
          return null;
        },

        "set": function(key, value)
        {
          try {
            return storage[this.prefix+key] = value;
          } catch(ex) { this.report("developer", "error", ex) }
          return value;
        },

        "delete": function(key)
        {
          try {
            delete storage[this.prefix+key];
          } catch(ex) { this.report("developer", "error", ex) }
        }
      }

      var defaultFavIcon;
      function changeFavIcon(newFavIcon) {
        var link = document.getElementsByTagName("link")[0];

        if (!defaultFavIcon)
          defaultFavIcon = link.href;

        if (!newFavIcon)
          newFavIcon = defaultFavIcon;

        if (link.href == newFavIcon)
          return;

        var newLink = document.createElement("link");

        newLink.setAttribute("rel", "icon");
        newLink.setAttribute("href", newFavIcon);

        link.parentNode.replaceChild(newLink, link);
      }
    </script>
  </head>
  <body onload="onLoad()">
    <div id="useff">
      <div id="useffbox">
        OneTeam works only on Firefox (version 2 or newer).<br>
        Please <a href="http://www.mozilla.com/firefox/">install Firefox</a> and try again.
      </div>
    </div>
    <div id="launch">
      <div id="launchbox">
        <button id="launchButton" onclick="launch()">Launch OneTeam</button>
        <input id="mode" type="checkbox" checked="checked">Open in new window</button>
      </div>
    </div>
    <iframe id="frame">
    </iframe>
  </body>
</html>
